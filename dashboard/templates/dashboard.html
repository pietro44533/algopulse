<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
  <title>Segnale Tecnico</title>

  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Segnale Tecnico">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1976d2">
  <meta name="format-detection" content="telephone=no">
  
  <!-- iOS specific fixes -->
  <script>
    // Previene lo zoom quando si clicca su input su iOS
    document.addEventListener('DOMContentLoaded', function() {
      if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
        document.querySelector('meta[name="viewport"]').setAttribute('content',
          'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no');
        
        // Gestione migliore della tastiera su iOS
        document.body.addEventListener('focusin', function() {
          window.scrollTo(0, 0);
          document.body.scrollTop = 0;
        });
      }
    });
    
  </script>
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/images/icon_192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/icon_192x192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon_192x192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/images/icon_192x192.png">
  
  <!-- Manifest -->
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/dashboard.css?v=14">

  <!-- CSS aggiuntivo per compatibilitÃ  -->
  <style>
    .strategia, .campionato {
      margin-bottom: 4px;
    }

    .quote, .indicatori {
      margin-top: 6px;
    }

    .tech {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }

    .tech span {
      display: inline-block;
      margin-right: 10px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .parser-ok {
      background-color: #d4f4d4;
      color: #155d15;
    }

    .api-ok {
      background-color: #d4f4d4;
      color: #155d15;
    }

    .api-ko {
      background-color: #f7d6d6;
      color: #820000;
    }

    .trade-ok {
      background-color: #d4f4d4;
      color: #155d15;
    }

    .trade-ko {
      background-color: #f7d6d6;
      color: #820000;
    }

    .add-task-btn-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #1976d2;
      color: #fff;
      border: none;
      font-size: 1.3em;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-task-btn-circle:hover {
      background: #1565c0;
    }

    .add-task-btn {
      display: block;
      margin-bottom: 18px; /* o la distanza che preferisci */
    }
  </style>
</head>
<body>
  <!-- ðŸ”˜ Task interattivi con campanella -->
  <div class="task-bar">
    {% for regola in regole %}
      <span class="pill" data-filter="{{ regola.filter|default('')|lower|replace(' ', '-') }}" data-filter-raw="{{ regola.filter }}">
        {{ regola.filter or 'Task' }}
        <span class="bell" data-task="{{ regola.filter|default('')|lower|replace(' ', '-') }}">ðŸ””</span>
      </span>
    {% endfor %}
  </div>

  <!-- ðŸŸ¢ Stato Telegram -->
  <div class="status">ðŸ“¨ Telegram: OK</div>

  <!-- Container per le task -->
  <div id="tasks-container">
    <!-- Box per "goal ht" -->
    <div class="match-box" id="goal-ht-box">
      <div class="header">goal ht</div>
      <div class="messages">
        <!-- I messaggi verranno caricati dinamicamente dall'API -->
      </div>
    </div>
    
    <!-- Box per "prova" -->
    <div class="match-box" id="prova-box" style="display: none;">
      <div class="header">prova</div>
      <div class="messages">
        <!-- I messaggi verranno caricati dinamicamente dall'API -->
      </div>
    </div>
  </div>

  <script>
    // ðŸ” Filtro match-box al clic sulla pillola
    document.querySelectorAll('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        const filtro = pill.getAttribute('data-filter');

        document.querySelectorAll('.match-box').forEach(box => {
          box.style.display = box.getAttribute('data-task') === filtro ? 'block' : 'none';
        });

        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
      });
    });

    // ðŸ”” Toggle notifiche al clic sulla campanella
    document.querySelectorAll('.bell').forEach(bell => {
      bell.addEventListener('click', (e) => {
        e.stopPropagation(); // âš ï¸ evita attivazione filtro

        bell.classList.toggle('off');
        bell.textContent = bell.classList.contains('off') ? 'ðŸ”•' : 'ðŸ””';

        const task = bell.getAttribute('data-task');
        const stato = bell.classList.contains('off') ? 'DISATTIVATE' : 'ATTIVE';
        console.log(`ðŸ”” Notifiche per ${task}: ${stato}`);
      });
    });

    // Event delegation per la rimozione delle task
    document.querySelector('.task-bar').addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-task-btn')) {
        e.stopPropagation();
        const pill = e.target.closest('.pill');
        let filter = pill.getAttribute('data-filter-raw');
        if (window.confirm('Sei sicuro di voler eliminare questa task?')) {
          fetch('/api/rimuovi_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filter: filter })
          })
          .then(res => res.json())
          .then(data => {
            if (data.ok) {
              document.querySelectorAll('.pill[data-filter-raw="' + filter + '"]').forEach(p => p.remove());
            } else {
              alert('Errore: ' + (data.error || 'Impossibile rimuovere la task'));
            }
          })
          .catch(() => {
            alert('Errore di rete nella rimozione della task');
          });
        }
      }
    });

    function addTaskPrompt() {
      const name = prompt("Nome della nuova task/canale:");
      if (!name) return;

      fetch('/api/aggiungi_task', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filter: name })
      })
      .then(res => res.json())
      .then(data => {
        console.log('DEBUG risposta aggiungi_task:', data);
        if (data.ok) {
          window.location.reload();
        } else {
          alert('Errore: ' + (data.error || 'Impossibile aggiungere la task'));
        }
      });
    }

    // --- MESSAGGI LIVE PER TASK ---
    // Funzione renderLiveMessage rimossa - tutto gestito da dashboard.js esterno
    // function renderLiveMessage(msg) { ... }

    // Funzione fetchLiveMessages rimossa - tutto gestito da dashboard.js esterno
    // function fetchLiveMessages() { ... }
    // JavaScript inline rimosso - tutto gestito da dashboard.js esterno
    // setTimeout(() => {
    //   setInterval(fetchLiveMessages, 5000);
    // }, 3000);
  </script>

  <!-- JavaScript -->
  <script src="/js/dashboard.js?v=57&t={{ range(100000, 999999) | random }}"></script>

  <script>
    // Registrazione del service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('ServiceWorker registrazione completata con successo');
        })
        .catch(err => {
          console.log('Errore durante la registrazione del ServiceWorker:', err);
        });
    }
  </script>
</body>
</html>
